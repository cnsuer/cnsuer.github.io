<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"/><meta property="og:site_name" content="Restver's Blog"/><link rel="canonical" href="https://cnsuer.github.io/articles/oc-webview-promise"/><meta name="twitter:url" content="https://cnsuer.github.io/articles/oc-webview-promise"/><meta property="og:url" content="https://cnsuer.github.io/articles/oc-webview-promise"/><title>OC ä»£ç  webview æ‰§è¡Œ JS,å¦‚ä½•æœ‰æ•ˆçš„æ¶ˆé™¤å›è°ƒåœ°ç‹± | Restver's Blog</title><meta name="twitter:title" content="OC ä»£ç  webview æ‰§è¡Œ JS,å¦‚ä½•æœ‰æ•ˆçš„æ¶ˆé™¤å›è°ƒåœ°ç‹± | Restver's Blog"/><meta property="og:title" content="OC ä»£ç  webview æ‰§è¡Œ JS,å¦‚ä½•æœ‰æ•ˆçš„æ¶ˆé™¤å›è°ƒåœ°ç‹± | Restver's Blog"/><meta name="description" content="Programming & Life"/><meta name="twitter:description" content="Programming & Life"/><meta property="og:description" content="Programming & Life"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@Hanley_Lei"/><meta name="twitter:creator" content="@Hanley_Lei"/><meta name="referrer" content="no-referrer"/><link rel="stylesheet" href="/css/styles.css" type="text/css"/><link rel="stylesheet" href="/css/code.css" type="text/css"/><link rel="stylesheet" href="/css/toc.css" type="text/css"/><link rel="stylesheet" href="/css/font.css" type="text/css"/><link rel="stylesheet" href="/css/search.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/img/icon_site.JPG" type="image/jpeg"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Restver's Blog"/><script src="/js/jquery.min.js"></script><link rel="stylesheet" href="/css/heti.min.css"/><meta name="theme-color" content="#C62F1C"/></head><body class="item-page"><header><div class="wrapper"><div class="logo"><a href="/"><img src="/img/icon_site.JPG"/></a></div><div><div class="headerIcons"><a class="icon headIconTwitter" href="https://www.twitter.com/" target="_blank" rel="noreferrer"></a><a class="icon headIconEmail" href="mailto:restver@gmail.com" target="_blank" rel="noreferrer"></a><a class="icon headIconGithub" href="https://github.com/restver/" target="_blank" rel="noreferrer"></a><a class="icon headIconZhihu" href="https://www.zhihu.com/" target="_blank" rel="noreferrer"></a><a class="icon headIconRss" href="/feed.rss" target="_blank" rel="noreferrer"></a></div></div><nav><ul><li><a href="/">æœ€è¿‘æ›´æ–°</a></li><li><a class="selected" href="/articles">å…¨éƒ¨æ–‡ç« </a></li><li><a href="/about">å…³äº</a></li><li><a href="/search">æœç´¢</a></li></ul><div class="weixinHeadQcode" onclick="$('.weixinHeadQcode').css('display','none');"></div></nav></div></header><div class="container"><div class="wrapper"><div class="viewContainer"><div class="centerContent"><div class="post-actions"><div class="actionButton"><div class="actionButton twitter" onclick="window.open('https://twitter.com/intent/tweet?text=OC ä»£ç  webview æ‰§è¡Œ JS,å¦‚ä½•æœ‰æ•ˆçš„æ¶ˆé™¤å›è°ƒåœ°ç‹±&url=https://cnsuer.github.io/articles/oc-webview-promise&via=Hanley_Lei','target','');"></div></div><div class="actionButton"><div class="actionButton comment" onclick="$('html,body').animate({scrollTop: $('#gitalk-container').offset().top }, {duration: 500,easing:'swing'})"></div></div></div><article><div class="post-title"><h1>OC ä»£ç  webview æ‰§è¡Œ JS,å¦‚ä½•æœ‰æ•ˆçš„æ¶ˆé™¤å›è°ƒåœ°ç‹±</h1></div><div><ul class="tag-list"><li class="tag variant-4"><a href="/tags/webview">â¦¿webview</a></li><li class="tag variant-2"><a href="/tags/promise">â¦¿promise</a></li><li class="tag variant-1"><a href="/tags/oc">â¦¿oc</a></li><li class="tagdate"></li><li class="reading-time">ğŸ‘“ 4 min</li></ul><div class="content"><h1>OC ä»£ç  webview æ‰§è¡Œ JS,å¦‚ä½•æœ‰æ•ˆçš„æ¶ˆé™¤å›è°ƒåœ°ç‹±</h1><p>åœ¨é¡¹ç›®ä¸­,å¶å‘çš„æŠ¥ä¸€ä¸ª JS é”™è¯¯ <code>A lavaScript exception occurred</code> ,æ‰¾åˆ°è¿™æ®µçš„å…·ä½“å®ç°</p><pre><code>const scrDom = document.<span class="call">createElement</span>(<span class="string">"script"</span>);
scrDom.<span class="property">src</span> = basic.<span class="property">min</span>.<span class="property">js</span>;
scrDom.<span class="call">addEventListener</span>(<span class="string">"load"</span>, () =&gt; {
  <span class="keyword">if</span> (!haveMacJS) {
    window.<span class="property">webkit</span>.<span class="property">messageHandlers</span>.<span class="property">setPlanSucceed</span>.<span class="call">postMessage</span>(<span class="string">""</span>);
  }
});
const macScrDom = document.<span class="call">createElement</span>(<span class="string">"script"</span>);
macScrDom.<span class="property">src</span> = mac.<span class="property">min</span>.<span class="property">js</span>;
macScrDom.<span class="call">addEventListener</span>(<span class="string">"load"</span>, () =&gt; {
  window.<span class="property">webkit</span>.<span class="property">messageHandlers</span>.<span class="property">setPlanSucceed</span>.<span class="call">postMessage</span>(<span class="string">""</span>);
});
</code></pre><p>å‘ç°é€»è¾‘æ˜¯å½“éœ€è¦åœ¨ <code>webView</code> ä¸­ åŠ è½½ä¸¤ä¸ªç²¾ç®—æ–‡ä»¶,å¹¶ä¸”ç­‰åˆ°è¿™ä¸¤ä¸ªç²¾ç®—æ–‡ä»¶éƒ½åŠ è½½å®Œæ¯•å,å†é€šçŸ¥ native ç«¯,æŠŠå‚æ•°ä¼ å›åˆ° webView,æ‰§è¡Œè®¡ç®—,å‘ç°è¿™æ®µä»£ç å¹¶ä¸æ˜¯æŒ‰é¡ºåºæ‰§è¡Œå®Œ,ç„¶åæ‰é€šçŸ¥ native ç«¯çš„.</p><p>å‡ºç°é—®é¢˜çš„åŸå› æ˜¯,éœ€è¦åœ¨ JS ç«¯å’Œ Native ç«¯æ¥å›ä¼ å‚,æ— å½¢ä¸­å¢åŠ äº†é—®é¢˜å‡ºç°çš„æ¦‚ç‡,ä¸ºäº†éµå¾ªç›¸åŒé€»è¾‘,åŒä¸€åœ°æ–¹å¤„ç†çš„åŸåˆ™,å°±åœ¨ native ç«¯åŠ è½½è¿™ä¸¤ä¸ª JS æ–‡ä»¶</p><pre><code><span class="type">NSString</span> *basicString = [<span class="type">NSString</span> stringWithContentsOfFile: basicJsPath encoding:<span class="type">NSUTF8StringEncoding</span> error: <span class="keyword">nil</span>];
<span class="comment">// åŠ è½½ç¬¬ä¸€ä¸ªjsæ–‡ä»¶</span>
[webView evaluateJavaScript: basicString completionHandler:^(id <span class="type">_Nullable</span> res, <span class="type">NSError</span> * <span class="type">_Nullable</span> basicError) {
	  <span class="comment">//å¦‚æœéœ€è¦åŠ è½½ç¬¬äºŒä¸ªæ–‡ä»¶</span>
		<span class="keyword">if</span> ([<span class="type">RFileTool</span> existFileAtPath: macroJsPath])
	  {
				<span class="comment">//ç¬¬äºŒä¸ªç²¾ç®—æ–‡ä»¶å­˜åœ¨çš„è¯,åŠ è½½å®ƒ</span>
        <span class="type">NSString</span> *macroString = [<span class="type">NSString</span> stringWithContentsOfFile: macroJsPath encoding:<span class="type">NSUTF8StringEncoding</span> error:<span class="keyword">nil</span>];
        [weakWebView evaluateJavaScript: macroString completionHandler:^(id <span class="type">_Nullable</span> response, <span class="type">NSError</span> * <span class="type">_Nullable</span> macroError) {
            <span class="comment">// ç¬¬äºŒä¸ªæ–‡ä»¶åŠ è½½æˆåŠŸçš„è¯,é€šçŸ¥webView,æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span>
            <span class="type">NSString</span> *javaScriptString = [<span class="type">NSString</span> stringWithFormat:<span class="keyword">@"setPlan</span>('%<span class="keyword">@</span>',%d)<span class="string">", weakSelf.lastPlanId, YES];</span>
            [weakWebView evaluateJavaScript:javaScriptString completionHandler:^(id <span class="type">_Nullable</span> response, <span class="type">NSError</span> * <span class="type">_Nullable</span> error) {
                <span class="comment">//åˆå§‹åŒ–æˆåŠŸ,è°ƒç”¨nativeçš„è®¡ç®—æ–¹æ³•.</span>
								[weakSelf loadCalculate];
            }];
        }];
    }
		<span class="keyword">else</span>
		{
				<span class="comment">// ä¸éœ€è¦åŠ è½½ç¬¬äºŒä¸ªç²¾ç®—æ–‡ä»¶çš„è¯,é€šçŸ¥webView,æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span>
        <span class="type">NSString</span> *javaScriptString = [<span class="type">NSString</span> stringWithFormat:<span class="keyword">@"setPlan</span>('%<span class="keyword">@</span>',%d)<span class="string">", weakSelf.lastPlanId, NO];</span>
        [weakWebView evaluateJavaScript:javaScriptString completionHandler:^(id <span class="type">_Nullable</span> response, <span class="type">NSError</span> * <span class="type">_Nullable</span> error) {
            <span class="comment">//åˆå§‹åŒ–æˆåŠŸ,è°ƒç”¨nativeçš„è®¡ç®—æ–¹æ³•.</span>
						[weakSelf loadCalculate];
        }];
		}
}];
</code></pre><p>ä»¥ä¸Šä¸€ä¸ªçš„æ–¹æ³•ä¸­,å¥—äº†ä¸‰å±‚å›è°ƒ,è¿™è¿˜æ˜¯çœç•¥äº†å¤„ç†é”™è¯¯çš„æƒ…å†µä¸‹,å¦‚æœå†åŠ ä¸Šé”™è¯¯å¤„ç†,è¿™é‡Œçš„ä»£ç å°†ä¼šå˜çš„éå¸¸çš„å¤šä»¥åŠä¸‘é™‹.</p><p>å¦‚æœèƒ½åƒå…¶ä»–è¯­è¨€ä¸­,Promise é“¾å¼è°ƒç”¨æ–¹å¼,ä»£ç å°±ä¼šå˜çš„æ¸…æ™°äº†,å¯æƒœ OC ä¸æ”¯æŒ Promise,åªèƒ½è‡ªå·±å®ç°äº†.</p><p>å…ˆçœ‹ä¸‹æœ€ç»ˆæ•ˆæœ,ç„¶åè®²è§£å…·ä½“çš„å®ç°é€»è¾‘,è™½ç„¶ä»£ç é‡çœ‹ä¸Šå»æ²¡å°‘å¤šå°‘,ä½†æ˜¯è°ƒç”¨é€»è¾‘æ¸…æ™°å¤šäº†,ä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤šé‡å¤ä»£ç äº†.å½“ç„¶è¿™é‡Œæ¯ä¸€ä¸ª promise å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª catch,è¿™é‡Œæ˜¯ä¸ºäº†ç»Ÿè®¡å…·ä½“æ˜¯å“ªä¸€ä¸ª js åŠ è½½å‡ºé”™äº†,å¦‚æœä¸éœ€è¦è¿™æ ·ç»Ÿè®¡,å¯ä»¥ä¿®æ”¹ä»£ç ,ç»Ÿä¸€ catch</p><pre><code><span class="comment">//promiseå…¥å£,ä½¿ç”¨ç±»æ–¹æ³•firstlyWithJSEvaluator,åˆ›å»ºç¬¬ä¸€ä¸ªpromise</span>
[[[[[[[<span class="type">RJSEvalPromise</span> firstlyWithJSEvaluator: webView js: ^<span class="type">NSString</span> * (void) {
    <span class="comment">//è¿”å›éœ€è¦åŠ è½½çš„jsæ–‡ä»¶</span>
    <span class="type">NSString</span> *basicString = [<span class="type">NSString</span> stringWithContentsOfFile: basicJsPath encoding:<span class="type">NSUTF8StringEncoding</span> error: <span class="keyword">nil</span>];
    <span class="keyword">return</span> basicString;
}] <span class="keyword">catch</span>:^(<span class="type">NSError</span> * <span class="type">_Nonnull</span> basicError) {
		<span class="comment">//å¤„ç†åŠ è½½jså‡ºé”™çš„æƒ…å†µ</span>
    <span class="type">NSLogDebug</span>(<span class="string">@"âŒ---load basic js file:%@ faile--error:%@---âŒ", self.lastPlanId, basicError);</span>
}] then: ^<span class="type">NSString</span> * (void) {
		<span class="comment">//ç¬¬ä¸€ä¸ªjsæ‰§è¡Œå®Œæ¯•å,è¿™é‡Œè¿”å›éœ€è¦åŠ è½½çš„ç¬¬äºŒä¸ªjsæ–‡ä»¶</span>
    <span class="keyword">if</span> (isHaveMacro)
    {
        <span class="type">NSString</span> *macroString = [<span class="type">NSString</span> stringWithContentsOfFile: macroJsPath encoding:<span class="type">NSUTF8StringEncoding</span> error: <span class="keyword">nil</span>];
        <span class="keyword">return</span> macroString;
    }
    <span class="keyword">return nil</span>;
}] <span class="keyword">catch</span>:^(<span class="type">NSError</span> *macroError) {
		<span class="comment">//å¤„ç†åŠ è½½jså‡ºé”™çš„æƒ…å†µ</span>
    <span class="type">NSLogDebug</span>(<span class="string">@"âŒ---load macro js file:%@ faile--error:%@---âŒ", self.lastPlanId, macroError);</span>
}] then: ^<span class="type">NSString</span> * (void) {
		<span class="comment">//é€šçŸ¥webView,æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</span>
    <span class="type">NSString</span> *javaScriptString = [<span class="type">NSString</span> stringWithFormat:<span class="keyword">@"setPlan</span>('%<span class="keyword">@</span>',%d)<span class="string">", self.lastPlanId, isHaveMacro];</span>
    <span class="keyword">return</span> javaScriptString;
}] <span class="keyword">catch</span>:^(<span class="type">NSError</span> *setPlanError) {
    <span class="type">NSLogDebug</span>(<span class="string">@"âŒ---set plan:%@ faile--error:%@---âŒ", self.lastPlanId, setPlanError);</span>
}] finaly: ^<span class="type">NSString</span> * (void) {
		<span class="comment">//åˆå§‹åŒ–æˆåŠŸ,è°ƒç”¨nativeçš„è®¡ç®—æ–¹æ³•.</span>
		[<span class="keyword">self</span> loadCalculate];
}];
</code></pre><h3>RJSEvalPromise çš„å®ç°é€»è¾‘</h3><p><code>firstlyWithJSEvaluator</code> è¿™ä¸ªæ–¹æ³•éœ€è¦ä¼ ä¸¤ä¸ªå‚æ•°,ç¬¬ä¸€ä¸ªæ˜¯ JS æ‰§è¡Œç¯å¢ƒ,ä¹Ÿå°±æ˜¯ <code>webView</code>, ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°,ç±»å‹å®šä¹‰ä¸º <code>typedef NSString *_Nullable(^SQSPromiseFirstCallback)(void);</code> ,å›è°ƒå‡½æ•°è°ƒç”¨å,è¿”å›çš„å°±æ˜¯éœ€è¦æ‰§è¡Œçš„ JS ä»£ç ,è¿™é‡Œç›´æ¥è¿”å›äº† promise,å´æ²¡å¯¹å®ƒå¼ºå¼•ç”¨,ä¼šä¸ä¼šå¯¼è‡´åœ¨ JS æ‰§è¡Œå‰è‡ªåŠ¨é‡Šæ”¾å‘¢,ç­”æ¡ˆæ˜¯ä¸ä¼š,å› ä¸ºåœ¨ <code>aciton</code> å®ç°ä¸­, <code>webView</code> çš„å›è°ƒå‡½æ•°ä¼šæ•è·è¿™ä¸ª promise å¯¹è±¡</p><pre><code><span class="comment">//RJSEvalPromise.m</span>
+ (instancetype)firstlyWithJSEvaluator:(<span class="type">WKWebView</span> *)jsEvaluator js:(<span class="type">SQSPromiseFirstCallback</span>)<span class="call">js</span> {
    <span class="type">RJSEvalPromise</span>* promise = [<span class="type">RJSEvalPromise</span> makePromiseWithJSEvaluator: jsEvaluator js: js];
    promise.<span class="call">aciton</span>();
    promise.<span class="property">aciton</span> = <span class="keyword">nil</span>;
    <span class="keyword">return</span> promise;
}
</code></pre><p><code>makePromiseWithJSEvaluator</code> å°±æ˜¯çœŸæ­£åˆ›å»º promise å¯¹è±¡çš„æ–¹æ³•,è¿™é‡Œå®šä¹‰ promise çš„å…·ä½“æ‰§è¡Œé€»è¾‘,è¿™é‡Œ promise çš„ action ä¸­ç›´æ¥ä½¿ç”¨äº† promise,å´ä¸ä¼šå¾ªç¯å¼•ç”¨çš„åŸå› æ˜¯ä¸Šè¾¹åœ¨è°ƒç”¨ action å,ç›´æ¥æŠŠ action æ‰‹åŠ¨ç½®ä¸º nil,æ¶ˆé™¤äº†å¾ªç¯å¼•ç”¨,ä½†æ˜¯ç¼–è¯‘å™¨ä¼šå¼¹å‡ºè­¦å‘Š,æ‰€ä»¥åŠ ä¸Š <code>diagnostic ignored</code> è®©ç¼–è¯‘å™¨å¿½ç•¥æ‰è¿™ä¸ªè­¦å‘Š</p><pre><code>+ (instancetype)makePromiseWithJSEvaluator:(<span class="type">WKWebView</span> *)jsEvaluator js:(<span class="type">SQSPromiseFirstCallback</span>)js{
    <span class="type">RJSEvalPromise</span> * promise = [[<span class="type">RJSEvalPromise</span> alloc] <span class="keyword">init</span>];
    promise.<span class="property">jsEvaluator</span> = jsEvaluator;
    promise.<span class="property">state</span> = <span class="type">RJSEvalPromiseStatePending</span>;
#pragma clang diagnostic push
#pragma clang diagnostic ignored <span class="string">"-Warc-retain-cycles"</span>
    promise.<span class="property">aciton</span> = ^{
        <span class="type">NSString</span> *string = <span class="call">js</span>();
        <span class="comment">// if no need evaluateJavaScript, then Fulfilled.</span>
        <span class="keyword">if</span> (!string)
        {
            promise.<span class="property">state</span> = <span class="type">RJSEvalPromiseStateFulfilled</span>;
            [promise resume];
            <span class="keyword">return</span>;
        }
        [jsEvaluator evaluateJavaScript: string completionHandler:^(id <span class="type">_Nullable</span> result, <span class="type">NSError</span> * <span class="type">_Nullable</span> error) {
            promise.<span class="property">result</span> = result;
            promise.<span class="property">error</span> = error;
            <span class="keyword">if</span> (error) {
                promise.<span class="property">state</span> = <span class="type">RJSEvalPromiseStateRejected</span>;
            }<span class="keyword">else</span>{
                promise.<span class="property">state</span> = <span class="type">RJSEvalPromiseStateFulfilled</span>;
            }
            [promise resume];
        }];
    };
#pragma clang diagnostic pop
    <span class="keyword">return</span> promise;
}
</code></pre><p>webView è°ƒç”¨<code>evaluateJavaScript</code> æ–¹æ³•,æ‰§è¡Œ JS å,æ‹¿åˆ°æ‰§è¡Œçš„å…·ä½“ç»“æœ,ç»™å½“å‰çš„ promise èµ‹å€¼å¯¹åº”çš„çŠ¶æ€.ç„¶åè°ƒç”¨ <code>resume</code> æ–¹æ³•,çœ‹æ˜¯å¦å½“å‰çš„ promise é“¾,å·²ç»è°ƒç”¨å®Œæ¯•äº†</p><p><code>resume</code> çš„å®ç°å°±æ¯”è¾ƒç®€å•äº†,å¦‚æœçŠ¶æ€æ˜¯ <code>Pending</code> çš„è¯,ç›´æ¥è¿”å›,æ˜¯ <code>Rejected</code> ,é‚£ä¹ˆå‡ºç°é”™è¯¯äº†,è°ƒ <code>catch</code> å›è°ƒå‡½æ•°,ç„¶åçœ‹æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ª promise,æœ‰çš„è¯å°±æ‰§è¡Œå®ƒçš„ action æ–¹æ³•,ç›´åˆ° promise é“¾è°ƒç”¨å®Œæ¯•</p><pre><code>- (void)<span class="call">resume</span> {
    <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="property">state</span> == <span class="type">RJSEvalPromiseStatePending</span>)
    {
        <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="property">state</span> == <span class="type">RJSEvalPromiseStateRejected</span>)
    {
        <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="property">catchCallback</span>) {
            <span class="keyword">self</span>.<span class="call">catchCallback</span>(<span class="keyword">self</span>.<span class="property">error</span>);
        }
    }
    <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="property">nextFuture</span>.<span class="property">aciton</span>) {
        <span class="keyword">self</span>.<span class="property">nextFuture</span>.<span class="call">aciton</span>();
    }
    <span class="keyword">self</span>.<span class="property">nextFuture</span>.<span class="property">aciton</span> = <span class="keyword">nil</span>;
    <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="property">finalCallback</span>) {
        <span class="keyword">self</span>.<span class="call">finalCallback</span>(<span class="keyword">self</span>.<span class="property">result</span>);
    }<span class="keyword">else if</span> (<span class="keyword">self</span>.<span class="property">emptyFinalCallback</span>) {
        <span class="keyword">self</span>.<span class="call">emptyFinalCallback</span>();
    }
}
</code></pre><p>å½“ç„¶è¿™é‡Œ,ä¹Ÿå¯ä»¥ä¿®æ”¹ä¸º,å¦‚æœå‘ç”Ÿé”™è¯¯çš„è¯,å°±ä¸å†æ‰§è¡Œä¸‹ä¸€ä¸ª promise äº†,ç›´æ¥å¾ªç¯æŸ¥æ‰¾æœ€åä¸€ä¸ª catch å›è°ƒ.</p><pre><code><span class="keyword">if</span> (<span class="keyword">self</span>.<span class="property">state</span> == <span class="type">RJSEvalPromiseStateRejected</span>)
{
    <span class="keyword">while</span> (<span class="keyword">self</span>.<span class="property">nextFuture</span> &amp;&amp; <span class="keyword">self</span>.<span class="property">nextFuture</span>.<span class="property">catchCallback</span>) {
        <span class="keyword">self</span>.<span class="property">catchCallback</span> = <span class="keyword">self</span>.<span class="property">nextFuture</span>.<span class="property">catchCallback</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">self</span>.<span class="property">catchCallback</span>) {
        <span class="keyword">self</span>.<span class="call">catchCallback</span>(<span class="keyword">self</span>.<span class="property">error</span>);
    }
}
</code></pre><p>å“¦,å¯¹äº†,è¿˜æœ‰ <code>then</code> æ–¹æ³•,å®ƒçš„å®ç°å’Œ <code>firstlyWithJSEvaluator</code>åŸºæœ¬ç›¸åŒ,è°ƒç”¨ <code>makePromiseWithJSEvaluator</code> ç„¶åä¿å­˜åˆ›å»ºçš„è¿™ä¸ª promise å¯¹è±¡.</p><pre><code>- (instancetype)then:(<span class="type">SQSPromiseFirstCallback</span>)<span class="call">callback</span> {
    <span class="type">RJSEvalPromise</span>* promise = [<span class="type">RJSEvalPromise</span> makePromiseWithJSEvaluator: <span class="keyword">self</span>.<span class="property">jsEvaluator</span> js: callback];
    <span class="keyword">self</span>.<span class="property">nextFuture</span> = promise;
    [<span class="keyword">self</span> resume];
    <span class="keyword">return</span> promise;
}
</code></pre><p>è¿˜æœ‰ <code>catch</code> å’Œ <code>finally</code> æ–¹æ³•éƒ½æ˜¯ä»…ä»…ä¿å­˜äº†å›è°ƒå‡½æ•°,ç­‰å¾…æ‰§è¡Œ JS å‡ºç»“æœå,åœ¨ resume æ–¹æ³•ä¸­è°ƒç”¨</p><pre><code>- (instancetype)<span class="keyword">catch</span>:(void (^)(<span class="type">NSError</span> * <span class="type">_Nonnull</span>))<span class="call">callback</span> {
    <span class="keyword">self</span>.<span class="property">catchCallback</span> = callback;
    [<span class="keyword">self</span> resume];
    <span class="keyword">return self</span>;
}

- (void)finally:(void (^)(void))<span class="call">callback</span> {
    <span class="keyword">self</span>.<span class="property">emptyFinalCallback</span> = callback;
    [<span class="keyword">self</span> resume];
}
</code></pre><p>å½“ç„¶è¿™æ ·åš,æœ‰ä¸€å¤§å †çš„[] , <strong><code>å¦‚ä½•é€šè¿‡.(ç‚¹)è°ƒç”¨æ–¹æ³•å‘¢?</code></strong> iOS ä¸­ä½¿ç”¨ç‚¹è°ƒç”¨å±æ€§çš„æœ¬è´¨éƒ½æ˜¯è°ƒç”¨å±æ€§çš„ getter æ–¹æ³•æ¥è·å–å±æ€§å€¼. é‚£ä¹ˆè¿ç»­ä½¿ç”¨çš„.è°ƒç”¨,éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶å‘¢ï¼Ÿ</p><blockquote><p>1: å¿…é¡»æ˜¯å¯¹è±¡æ–¹æ³•;</p><p>2: å¿…é¡»æœ‰è¿”å›å€¼,è¿”å›å€¼çš„ç±»å‹æ˜¯å½“å‰å¯¹è±¡ç±»å‹</p><p>3: <strong>ä¸€å®šæ˜¯æ²¡æœ‰å‚æ•°çš„</strong></p></blockquote><p>çœ‹åˆ°ç¬¬ä¸‰ç‚¹çš„è¦æ±‚,ä¸èƒ½ä¼ å‚æ•°,é‚£æ€ä¹ˆæŠŠè¦æ‰§è¡Œçš„ JS ä¼ é€’è¿‡å»å‘¢? é‚£ä¹ˆå¯ä»¥åšä¸ªå˜æ›´,è¿”å›å€¼ä¸å†æ˜¯ä¸€ä¸ª promise å¯¹åƒ,è€Œè¿”å›ä¸€ä¸ª block,è¿™ä¸ª block,è°ƒç”¨å,å†è¿”å›ä¸ª promise å¯¹è±¡,å°±æ»¡è¶³äº†è¦æ±‚</p><pre><code>typedef <span class="type">RJSEvalPromise</span> *<span class="type">_Nullable</span>(^<span class="type">SQSPromiseDotThen</span>)(<span class="type">SQSPromiseFirstCallback</span>);

- (<span class="type">SQSPromiseDotThen</span>)<span class="call">then</span> {
    <span class="keyword">return</span> ^<span class="type">RJSEvalPromise</span> * <span class="type">_Nullable</span>(<span class="type">SQSPromiseFirstCallback _Nonnull</span> callback) {
        <span class="type">RJSEvalPromise</span>* promise = [<span class="type">RJSEvalPromise</span> makePromiseWithJSEvaluator: <span class="keyword">self</span>.<span class="property">jsEvaluator</span> js: callback jsResult: <span class="keyword">nil</span> result: <span class="keyword">nil</span>];
        <span class="keyword">self</span>.<span class="property">nextFuture</span> = promise;
        [<span class="keyword">self</span> resume];
        <span class="keyword">return</span> promise;
    };
}
</code></pre><p>è¿™æ ·å°±è¾¾åˆ°äº†,ä½¿ç”¨.è¯­æ³•çš„é“¾å¼è°ƒç”¨äº†</p><pre><code>[[<span class="type">RJSEvalPromise</span> firstlyWithJSEvaluator: webView js: ^<span class="type">NSString</span> * (void) {
    <span class="type">NSString</span> *basicString = [<span class="type">NSString</span> stringWithContentsOfFile: basicJsPath encoding:<span class="type">NSUTF8StringEncoding</span> error: <span class="keyword">nil</span>];
    <span class="keyword">return</span> basicString;
}].<span class="call">dotThen</span>(^<span class="type">NSString</span> * (void) {
    <span class="keyword">if</span> (isHaveMacro)
    {
        <span class="type">NSString</span> *macroString = [<span class="type">NSString</span> stringWithContentsOfFile: macroJsPath encoding:<span class="type">NSUTF8StringEncoding</span> error: <span class="keyword">nil</span>];
        <span class="keyword">return</span> macroString;
    }
    <span class="keyword">return nil</span>;
}).<span class="call">dotThen</span>(^<span class="type">NSString</span> * (void) {
    <span class="type">NSString</span> *javaScriptString = [<span class="type">NSString</span> stringWithFormat:<span class="keyword">@"setPlan</span>('%<span class="keyword">@</span>',%d)<span class="string">", self.lastPlanId, isHaveMacro];</span>
    <span class="keyword">return</span> javaScriptString;
}) finally:^{

}];
</code></pre><p>è‡³æ­¤,å®Œæˆäº†å›è°ƒåœ°ç‹±åˆ° promise é“¾å¼è°ƒç”¨çš„è½¬æ¢.</p></div><div class="license"><p>æœ¬åšå®¢æ–‡ç« é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC 4.0 åè®®</a>ï¼Œè½¬è½½éœ€æ³¨æ˜å‡ºå¤„å’Œä½œè€…ã€‚</p></div></div></article><div class="item-navigator"><table><tr><td class="previous-item"><a href="/articles/modulemap">åŠ¨æ€åº“ä¸­ä¸­ä½¿ç”¨modulemapä½¿OCä¸Swiftäº’ç›¸è°ƒç”¨</a></td><td></td></tr></table></div></div><div class="side-nav"><div class="sidebar"></div></div>    <script src="/js/toc.js"></script></div></div><footer><p>Copyright &copy; Restver 2023 <a href="http://beian.miit.gov.cn">äº¬ICPå¤‡20000113å·</a></p><p>Generated using <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a></p><ul><li><a href="https://twitter.com/" target="_blank"><img class="twitter" src="/img/twitter.svg"/></a></li><li><a href="https://github.com/restver/" target="_blank"><img src="/img/github.svg"/></a></li><li><a href="https://www.zhihu.com/" target="_blank"><img src="/img/zhihu.svg"/></a></li><li><a href="/feed.rss"><img src="/img/rss.svg"/></a></li></ul></footer></div></body></html>